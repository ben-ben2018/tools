<!DOCTYPE HTML>
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <link rel="shortcut icon" type="image/png" href="assets/icon.png">

  <title reclang="HQYi">Recorder H5: 用于html5网页中的前端录音解决方案，此录音插件支持mp3 wav pcm g711a g711u amr ogg webm格式，支持实时上传 语音识别 音频可视化
    实时处理，可在PC端 移动端 Android iOS 原生App中跨平台使用</title>

  <script>
    var PageLM = "2025-01-11 09:33";
    (function () {
      //加载核心库，其他类型支持库在下面根据用户点击选择加载，刷新页面可以恢复选择的类型
      var srcC = "./src/recorder-core.js";
      var initJss = [srcC];
      var tei = window.TypeEngineImports = {//不同类型编码器需要加载的js文件
        mp3: {
          src: [srcC, "./src/engine/mp3.js", "./src/engine/mp3-engine.js", 0, "./src/engine/wav.js"]
        }
        , wav: {
          src: [srcC, "./src/engine/wav.js"]
        }
        , pcm: {
          src: [srcC, "./src/engine/pcm.js", 0, "./src/engine/wav.js"]
        }
        , amr: {
          src: [srcC, "./src/engine/beta-amr.js", "./src/engine/beta-amr-engine.js", 0, "./src/engine/wav.js"]
        }
        , ogg: {
          src: [srcC, "./src/engine/beta-ogg.js", "./src/engine/beta-ogg-engine.js"]
        }
        , g711a: {}, g711u: {}
        , webm: {
          name: "webm(beta)", sort: 99,
          src: [srcC, "./src/engine/beta-webm.js"]
        }
      };
      tei.g711a.src = tei.g711u.src = [srcC, "./src/engine/g711x.js", 0, "./src/engine/wav.js"];

      window.Import_RecJs_Set = {};//刷新页面，加载选中的类型js
      if (/recImport=([^?#&]+)/.test(location.href)) {
        try {
          var o = JSON.parse(decodeURIComponent(RegExp.$1));
          var te = tei[o.type] || {}, jss = te["src"];
          if (!jss) throw "unknown type=" + o.type;
          Import_RecJs_Set = o; initJss = jss;
          console.log("recImport init", o, jss);
        } catch (e) {
          console.error("recImport init error", e);
        }
      }
      for (var i = 0; i < initJss.length; i++) {
        if (initJss[i]) {
          document.write('<scr' + 'ipt src="' + initJss[i] + '"></scr' + 'ipt>');
        }
      }
    })()
  </script>
</head>

<body>
  <div class="main">

    <!--加载可选扩展库-->
    <script src="./src/extensions/waveview.js"></script>
    <script src="./src/extensions/wavesurfer.view.js"></script>
    <script src="./src/extensions/lib.fft.js"></script>
    <script src="./src/extensions/frequency.histogram.view.js"></script>
    <script src="./src/extensions/create-audio.nmn2pcm.js"></script>

    <!--加载PlayBuffer-->
    <script src="./assets/runtime-codes/fragment.playbuffer.js"></script>


    <style>
      body {
        word-wrap: break-word;
        word-break: break-all;
        background: #f5f5f5 center top no-repeat;
        background-size: auto 680px;
      }

      pre {
        white-space: pre-wrap;
      }

      label,
      label * {
        cursor: pointer;
      }

      label:hover {
        color: #06c;
      }

      a {
        text-decoration: none;
        color: #06c;
      }

      a:hover {
        color: #f00;
      }

      .main {
        max-width: 700px;
        margin: 0 auto;
        padding-bottom: 80px
      }

      .mainBox {
        margin-top: 12px;
        padding: 12px;
        border-radius: 6px;
        background: #fff;
        --border: 1px solid #f60;
        box-shadow: 2px 2px 3px #aaa;
      }


      .btns button,
      .mainBtn {
        display: inline-block;
        cursor: pointer;
        border: none;
        border-radius: 3px;
        background: #f60;
        color: #fff;
        padding: 0 15px;
        margin: 3px 20px 3px 0;
        line-height: 36px;
        height: 36px;
        overflow: hidden;
        vertical-align: middle;
      }

      .btns button:active,
      .mainBtn:active {
        background: #f00;
      }

      .recwaveChoice {
        cursor: pointer;
        display: inline-block;
        vertical-align: bottom;
        border-right: 1px solid #ccc;
        background: #ddd;
        line-height: 28px;
        font-size: 12px;
        color: #666;
        padding: 0 5px;
      }

      .recwaveChoice:first-child {
        border-radius: 99px 0 0 99px;
      }

      .recwaveChoice:last-child {
        border-radius: 0 99px 99px 0;
        border-right: none;
      }

      .recwaveChoice.slc,
      .recwaveChoice:hover {
        background: #f60;
        color: #fff;
      }

      .lb {
        display: inline-block;
        vertical-align: middle;
        background: #00940e;
        color: #fff;
        font-size: 14px;
        padding: 2px 8px;
        border-radius: 99px;
      }

      .pd {
        padding: 0 0 6px 0;
      }
    </style>

    <script>
      //兼容环境
      function RandomKey() {
        return "randomkey" + (RandomKey.idx++);
      };
      RandomKey.idx = 0;
    </script>
    <script src="./assets/ztest-jquery.min-1.9.1.js"></script>

    <!-- begin 开始copy源码 -->
    <div class="demoMain">

      <div class="mainBox">
        <div class="pd">
          <span class="lb" reclang="Fwsy">类型 :</span> <span class="types"></span>
        </div>
        <div class="pd">
          <span class="lb" reclang="ArEi">提示 :</span> <span class="typeTips">-</span>
        </div>
        <div class="pd">
          <span class="lb" reclang="hSjb">比特率 :</span> <input type="text" class="bit" value="16" style="width:60px">
          <span reclang="oNuF">kbps，越大音质越好</span>
        </div>
        <div>
          <span class="lb" reclang="2oPC">采样率 :</span> <input type="text" class="sample" value="16000"
            style="width:60px">
          <span reclang="ldVn">hz，越大细节越丰富</span>
        </div>
      </div>

      <div class="mainBox">
        <div class="pd btns">
          <div>
            <button onclick="recopen()" style="margin-right:10px" reclang="fFtC">打开录音,请求权限</button>
            <button onclick="recclose()" style="margin-right:0" reclang="p3Kq">关闭录音,释放资源</button>
          </div>

          <button onclick="recstart()" reclang="FIoV">录制</button>
          <button onclick="recstop()" style="margin-right:80px" reclang="5bwK">停止</button>

          <span style="display: inline-block;">
            <button onclick="recpause()" reclang="abgd">暂停</button>
            <button onclick="recresume()" reclang="SWBS">继续</button>
          </span>
          <span style="display: inline-block;">
            <button onclick="recPlayLast()" reclang="WNdh">播放</button>
            <button onclick="recDownLast()" reclang="shLM">本地下载</button>
          </span>
        </div>

        <div class="pd recpower">
          <div style="height:40px;width:300px;background:#999;position:relative;">
            <div class="recpowerx" style="height:40px;background:#0B1;position:absolute;"></div>
            <div class="recpowert" style="padding-left:50px; line-height:40px; position: relative;"></div>
          </div>
        </div>
        <div class="pd">
          <button onclick="recstop2()" class="batEnc" reclang="uuZ6">批量编码</button>
          <input type="text" class="bits" value="8 to 96 step 8">
          <span reclang="dLMM">kbps 测试音质用的，除比特率外其他参数可调整</span>
        </div>
        <div class="pd waveBox">
          <div style="border:1px solid #ccc;display:inline-block">
            <div style="height:100px;width:300px;" class="recwave"></div>
          </div>

          <span style="font-size:0">
            <span class="recwaveChoice" key="WaveView">WaveView</span>
            <span class="recwaveChoice" key="SurferView">SurferView</span>
            <span class="recwaveChoice" key="Histogram1">Histogram1</span>
            <span class="recwaveChoice" key="Histogram2">H...2</span>
            <span class="recwaveChoice" key="Histogram3">H...3</span>
          </span>
        </div>
        <div class="pd pcmPageHide">
          <label><input type="checkbox" class="autoStopSet"><span reclang="hoh3">开始录制后定时</span></label>
          <input type="text" class="autoStopTime" value="60000" style="width:60px">
          <span reclang="CX5p">ms自动停止录音，定时录音</span>
        </div>
        <div class="pd pcmPageHide">
          <label><input type="checkbox" class="takeoffEncodeChunkSet"><span
              reclang="AWXs">接管编码器输出（takeoffEncodeChunk），切换后新打开录音生效</span></label>
        </div>
        <div class="pd pcmPageHide">
          <label><input type="checkbox" class="useAECSet"><span reclang="vIzT">尝试启用回声消除（echoCancellation）</span></label>
        </div>
      </div>

      <div class="mainBox">
        <audio class="recPlay" controls style="display:none;width:100%"></audio>
        <div class="reclog"></div>
        <div class="recLastLog"
          style="position:fixed;z-index:2;width:20vw;min-width:200px;max-height:100px;overflow:auto;right:0;bottom:0;background:#fff;padding:5px 10px;border-radius:6px 0 0 0;box-shadow:-1px -1px 3px #ddd;font-size:13px">
        </div>
      </div>

      <div class="mainBox">
        <div>
          <span class="lb" reclang="QDzU">切换麦克风 :</span>
          <select class="trackSet_device"></select>
          <span reclang="hYD7">从未请求过录音权限时，可能无法正常拉取设备列表，打开一次录音后可尝试</span>
          <button onclick="trackSetQueryDeviceList(1)" reclang="gNwv">重新拉取设备</button>
        </div>
        <div>
          <span class="lb">noiseSuppression :</span>
          <select class="trackSet_noise">
            <option value="" reclang="3K14">不设置</option>
            <option value="1">true</option>
            <option value="2">false</option>
          </select>
          <span reclang="Q0lg">降噪（ANS）配置开关</span>
        </div>
        <div>
          <span class="lb">echoCancellation :</span>
          <select class="trackSet_aec">
            <option value="" reclang="d6UL">不设置</option>
            <option value="1">true</option>
            <option value="2">false</option>
          </select>
          <span reclang="ujUi">回声消除（AEC）配置开关</span>
        </div>
        <div>
          <span class="lb">autoGainControl :</span>
          <select class="trackSet_gain">
            <option value="" reclang="K3dr">不设置</option>
            <option value="1">true</option>
            <option value="2">false</option>
          </select>
          <span reclang="gjGg">自动增益（AGC）配置开关</span>
        </div>
        <div>
          <span class="lb" reclang="h7dA">sampleRate :</span>
          <input class="trackSet_sr" style="width:60px">
          <span reclang="h7dB">（仅供测试）强制指定流的采样率，可能会出现浏览器不能正确选用麦克风、移动端无法启用回声消除等现象</span>
        </div>
        <div>
          <span style="color:#f60" reclang="fP77">以上参数设置后需重新打开录音</span><span
            reclang="7ots">；均为set中的audioTrackSet高级配置，会直接传递给浏览器的getUserMedia方法，不同浏览器的支持程度不同，并不一定会生效；这些参数不设置时浏览器给的默认状态是打开还是关闭将不确定；</span>
          <span style="color:#aaa"
            reclang="40Wa">移动端打开降噪、回声消除可能会表现的很怪异（包括系统播放音量变小），但iOS上如果关闭又可能导致录音没有声音，如需更改配置请Android和iOS分别配置，并测试好</span>
        </div>
      </div>

      <div class="mainBox">
        <span class="lb" reclang="HmBe">启用MediaRecorder :</span>
        <label>
          <input type="checkbox" class="enableWebMSet"><span reclang="WJse">启用</span>
          <span style="color:#f60" reclang="DIXY">设置后需重新打开录音</span>
        </label>

        <div reclang="w1aV">
          音频采集连接方式：启用时尝试使用MediaRecorder.WebM.PCM，默认启用，未启用或者不支持时使用AudioWorklet或ScriptProcessor；通过设置Recorder.ConnectEnableWebM=false禁用。
        </div>
        <div>
          <span style="color:#0b1" reclang="sdaw">使用MediaRecorder采集到的音频数据比其他方式更好，几乎不存在丢帧现象，所以音质明显会好很多，建议保持开启；</span>
          <span style="color:#aaa"
            reclang="rAmm">有些浏览器不支持录制PCM编码的WebM，如FireFox、低版本的Chrome，将依旧使用AudioWorklet或ScriptProcessor来连接采集。</span>
        </div>


        <div style="margin-top:12px;"></div>
        <span class="lb" reclang="C0vI">启用AudioWorklet :</span>
        <label>
          <input type="checkbox" class="enableWorkletSet"><span reclang="AW2s">启用</span>
          <span style="color:#f60" reclang="5Ve2">设置后需重新打开录音，ConnectEnableWebM如果启用并且有效时，本参数将不起作用</span>
        </label>

        <div reclang="o3Pt">
          音频采集连接方式：启用时尝试使用AudioWorklet，默认禁用，未启用或者不支持时使用ScriptProcessor；通过设置Recorder.ConnectEnableWorklet=true启用。</div>
        <div>
          <span reclang="R0N9">已知：AudioWorklet在一定条件下会导致某些浏览器崩溃</span>
          <a href="assets/ztest_chrome_bug_AudioWorkletNode.html" target="_blank" reclang="GQ6V">测试</a>
          <span reclang="8Nn9">(坑已填好)。</span>
        </div>
        <div class="workletSetTips" style="color:#f60"></div>
      </div>

      <div class="mainBox">
        <span class="lb" reclang="OOHq">丢失补偿 :</span>
        <label>
          <input type="checkbox" class="disableEnvInFixSet"><span
            reclang="Ft0s">禁用设备卡顿时音频输入丢失补偿功能（通过别的程序大量占用CPU来模拟设备卡顿）；</span>
          <span style="color:#f60" reclang="EE7G">设置后需重新打开录音</span>
          <span reclang="LqWd">；为set中disableEnvInFix配置值</span>
        </label>
        <div><a href="https://github.com/xiangyuecn/Recorder/issues/51">issues#51</a><span
            reclang="mpX0">如果没有进行补偿，录音时设备偶尔出现很卡的情况下（CPU被其他程序大量占用），浏览器采集到的音频是断断续续的，导致10秒的录音可能就只返回了5秒的数据量，这个时候最终编码得到的音频时长明显变短，播放时的效果就像快放一样。未禁用时会在卡顿时自动补偿静默音频，消除了快放效果，但由于丢失的音频已被静默数据代替，听起来就是数据本身的断断续续的效果。在设备不卡时录音没有此问题。</span>
        </div>

        <div style="margin-top:12px;">
          <span class="lb">Destroy :</span>
          <button onclick="callDestroy()" reclang="qTKw">调用Recorder.Destroy()</button>
          <span reclang="4xCn">Destroy会关闭所有的全局资源，包括AudioContext，当录音出现问题时，可尝试Destroy一下重试</span>
        </div>

        <div style="margin-top:12px;">
          <span class="lb" reclang="fbxW">阻止自动锁屏 :</span>
          <button onclick="wakeLockClick()" reclang="y0Vx">调用navigator.wakeLock 或 静音循环播放视频</button>
          <span reclang="5Fgu">手机锁屏后是否能录音不可控，直接简单粗暴的调用wakeLock接口 或 静音+循环播放视频来阻止锁屏，就是有点费电</span>
        </div>

        <div style="margin-top:12px;">
          <span class="lb" reclang="JbX0">暴力测试 :</span>
          <button onclick="testInject24HourPcmClick()" reclang="KPAW">开始注入</button>
          <input class="testInject24HourPcm_h" value="24" style="width:30px;text-align:right">
          <span reclang="ioLq">小时的录音数据，测试长时间录音编码和内存泄露</span>
        </div>

        <div style="margin-top:12px;">
          <span class="lb" reclang="4pBN">暴力测试 :</span>
          <button onclick="testMultipleOpen5()" reclang="KwYR">同时打开5个录音（并发调用open）</button>
          <span reclang="X9aU">，每个会录5秒，打开浏览器控制台查看日志</span>
        </div>
      </div>

      <div class="mainBox">
        <span class="lb" reclang="0Wqg">浏览器环境情况 :</span>
        <pre class="recinfoCode"></pre><textarea class="recinfoCodeTxt" style="display:none">
AudioContext:${"AudioContext" in window}
webkitAudioContext:${"webkitAudioContext" in window}
mediaDevices:${!!navigator.mediaDevices}
mediaDevices.getUserMedia:${!!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia)}
navigator.getUserMedia:${!!navigator.getUserMedia}
navigator.webkitGetUserMedia:${!!navigator.webkitGetUserMedia}
AudioContext.scriptProcessor:{{
						"createScriptProcessor" in (Recorder.Ctx||{})
					 || "createJavaScriptNode" in (Recorder.Ctx||{})
					}}
AudioContext.audioWorklet:{{"audioWorklet" in (Recorder.Ctx||{})}}
AudioWorkletNode:${"AudioWorkletNode" in window}
MediaRecorder:${"MediaRecorder" in window}
MediaRecorder.ondataavailable:${"MediaRecorder" in window && "ondataavailable" in MediaRecorder.prototype}
MediaRecorder.WebM.PCM:${"MediaRecorder" in window && MediaRecorder.isTypeSupported("audio/webm; codecs=pcm")}

URL:${location.href.replace(/#.+/g,"")}
UA:${navigator.userAgent}

<span reclang="qfGt">Recorder库修改时间（有可能修改了忘改）：</span>${Recorder.LM}
<span reclang="VXCO">本页面修改时间（有可能修改了忘改）：</span>${PageLM}
</textarea>

        <span class="lb" reclang="z6w4">问题自检 :</span> <span
          reclang="6TKY">录音时注意观察灰色区域是否有绿色音量跳动，没有绿色跳动说明Recorder没有获取到声音数据。如果测试发现mp3没有声音，可以试一下wav格式，如果wav格式有声音，说明内置lamejs
          mp3编码器有问题。如果都没有，下载下来播放看看有没有。下载下来也没有声音可以反馈一下。</span>
      </div>



      <script>
        function reclog(s, color) {
          var now = new Date();
          var t = ("0" + now.getHours()).substr(-2)
            + ":" + ("0" + now.getMinutes()).substr(-2)
            + ":" + ("0" + now.getSeconds()).substr(-2);
          var html = '<div style="color:' + (!color ? "" : color == 1 ? "red" : color == 2 ? "#0b1" : color) + '">[' + t + ']' + s + '</div>';
          $(".reclog").prepend(html);
          $(".recLastLog").html(html.replace(/class\s*=/ig, "clazz="));
        };
        window.onerror = function (message, url, lineNo, columnNo, error) {
          //https://www.cnblogs.com/xianyulaodi/p/6201829.html
          reclog('【Uncaught Error】' + message + '<pre>' + "at:" + lineNo + ":" + columnNo + " url:" + url + "\n" + (error && error.stack || "不能获得错误堆栈") + '</pre>', 1);
        };
      </script>



      <script>
        var rec, processTime;
        function recopen(call) {
          call || (call = function (msg) {
            msg && reclog(msg, 1);
          });
          if (rec && Recorder.IsOpen()) {//如果有老的，close掉重新开新的
            recclose();
          };
          var type = $("[name=type]:checked").val();
          var bit = +$(".bit").val();
          var sample = +$(".sample").val();

          cancelAutoStop();
          window.waveStore = {};
          window.takeoffChunks = [];

          var disableEnvInFixSet = $(".disableEnvInFixSet")[0].checked;
          if (disableEnvInFixSet) {
            reclog("已禁用设备卡顿时音频输入丢失补偿，可以通过别的程序大量占用CPU来模拟设备卡顿，然后录音听听未补偿时的播放效果，然后再试试不禁用的效果");
          };

          var enableWebM = $(".enableWebMSet")[0].checked;
          Recorder.ConnectEnableWebM = enableWebM;
          if (!enableWebM) {
            reclog("已禁用MediaRecorder.WebM.PCM", "#aaa");
          }

          var enableWorklet = $(".enableWorkletSet")[0].checked;
          Recorder.ConnectEnableWorklet = enableWorklet;
          if (enableWorklet) {
            reclog("已启用AudioWorklet" + (enableWebM ? "（同时启用了MediaRecorder，AudioWorklet只会在MediaRecorder未生效时采用）" : "") + ", " + workletTips, "#f60");
          }

          var audioTrackSet = null;
          var useAEC = $(".useAECSet")[0].checked;
          var trackSet_device = $(".trackSet_device").val();
          var trackSet_noise = useAEC ? 1 : $(".trackSet_noise").val();
          var trackSet_aec = useAEC ? 1 : $(".trackSet_aec").val();
          var trackSet_gain = useAEC ? 1 : $(".trackSet_gain").val();
          var trackSet_sr = +$(".trackSet_sr").val() || 0;
          if (trackSet_device || trackSet_noise || trackSet_aec || trackSet_gain || trackSet_sr) {
            audioTrackSet = {};
            if (trackSet_device) {
              var device = DeviceList[+trackSet_device];
              audioTrackSet.deviceId = device.deviceId;
              audioTrackSet.groupId = device.groupId;
            }
            if (trackSet_noise) {
              audioTrackSet.noiseSuppression = +trackSet_noise == 1;
            }
            if (trackSet_aec) {
              audioTrackSet.echoCancellation = +trackSet_aec == 1;
            }
            if (trackSet_gain) {
              audioTrackSet.autoGainControl = +trackSet_gain == 1;
            }
            if (trackSet_sr) {
              audioTrackSet.sampleRate = trackSet_sr;
            }

            reclog("已启用audioTrackSet配置：" + JSON.stringify(audioTrackSet));
          };

          var takeoffEncodeChunkSet = $(".takeoffEncodeChunkSet")[0].checked;

          rec = Recorder({
            type: type
            , bitRate: bit
            , sampleRate: sample
            , audioTrackSet: audioTrackSet
            , disableEnvInFix: disableEnvInFixSet
            , onProcess: function (buffers, powerLevel, duration, sampleRate, newBufferIdx, asyncEnd) {
              //优先进行pcm处理，可能会发生数据修改，对于需要大量运算的处理需要开启异步模式，onProcess返回true即可开启，异步操作完成后必须回调asyncEnd
              processTime = Date.now();

              $(".recpowerx").css("width", powerLevel + "%");
              $(".recpowert").text(formatMs(duration, 1) + " / " + powerLevel);

              //可视化图形绘制
              if (waveStore.choice != recwaveChoiceKey) {
                waveStore.choice = recwaveChoiceKey;
                $(".recwave").html("").append(waveStore[recwaveChoiceKey].elem);
              };
              waveStore[recwaveChoiceKey].input(buffers[buffers.length - 1], powerLevel, sampleRate);

              //注入24小时的录音数据
              if (window.testInject24HourPcmOnProc) {
                testInject24HourPcmOnProc(buffers, sampleRate);
              };
            }
            , takeoffEncodeChunk: !takeoffEncodeChunkSet ? null : function (chunkBytes) {
              if (window.testInject24HourPcmOnTake) {//注入24小时的录音数据
                testInject24HourPcmOnTake(chunkBytes);
              }
              takeoffChunks.push(chunkBytes);
            }
          });

          rec.open(function () {
            var typeSize = ", <span style='border:1px solid #bbb;background:#f5f5f5;'>";
            if (type == "wav") {
              typeSize += "1秒的wav文件大小(字节)估算公式：采样率 × 位数 ÷ 8，当前：" + sample + "*" + bit + "/8≈" + (sample * bit / 8) + "B/s";
            } else if (type == "mp3") {
              typeSize += "1秒的mp3文件大小(字节)估算公式：比特率 × 1000 ÷ 8，当前：" + bit + "*1000/8≈" + (bit * 1000 / 8) + "B/s";
            } else {
              typeSize = "";
            };
            typeSize && (typeSize += "</span>");

            reclog("<span style='color:#0b1'>" + "已打开:" + type + " " + sample + "hz " + bit + "kbps</span>" + typeSize);

            //此处创建这些音频可视化图形绘制浏览器支持妥妥的
            initWaveStore(waveStore, ".recwave");

            call();
          }, function (e, isUserNotAllow) {
            call((isUserNotAllow ? "UserNotAllow, " : "") + "打开失败：" + e);
          });
        };


        var callDestroy = function () {
          Recorder.Destroy();
          reclog("已执行Recorder.Destroy()");
          scrollToEl(".reclog");
        };

        //拉取麦克风设备列表
        var DeviceList = [];
        var trackSetQueryDeviceList = function (click) {
          var end = function (list, err) {
            DeviceList = list; var list2 = [];
            var opts = ['<option value="" rec' + 'lang="6BfR">' + (list.length ? "不设置" : err) + '</option>'];
            for (var i = 0; i < list.length; i++) {
              var o = list[i];
              if (o.deviceId && o.kind == "audioinput") {
                list2.push(o);
                var name = o.label || ((i + 1) + "# " + "无名称，可能是因为从来没有打开过录音");
                opts.push('<option value="' + i + '">' + name + '</option>');
              }
            }
            $(".trackSet_device").html(opts.join(" "));

            if (click) {
              console.log("DeviceList: ", JSON.parse(JSON.stringify(list)));
              reclog("已重新拉取到" + list2.length + "个设备，可切换要使用的麦克风", 2);
            }
          };
          if (navigator.mediaDevices && navigator.mediaDevices.enumerateDevices) {
            navigator.mediaDevices.enumerateDevices().then(end)["catch"](function (e) {
              end([], "拉取失败：" + e.message);
            });
          } else {
            end([], "此浏览器不支持拉取设备列表");
          }
        };
        trackSetQueryDeviceList();


        function recclose() {
          cancelAutoStop();
          if (rec) {
            rec.close(function () {
              reclog("已关闭");
            });
          } else {
            reclog("未打开录音", 1);
          };
        };
        function recstart(call) {
          cancelAutoStop();
          call || (call = function (msg) {
            msg && reclog(msg, 1);
          });
          if (rec && Recorder.IsOpen()) {
            testInject24HourPcmStore.sid++;
            takeoffChunks = [];

            //定时停止
            var autoStop = $(".autoStopSet")[0].checked;
            if (autoStop) {
              var time = +$(".autoStopTime").val() || 0;
              if (time < 100) {
                reclog("定时不能小于100ms", 1);
                return;
              };
              autoStopTimer = setTimeout(function () {
                autoStopTimer = 0;
                reclog("定时时间到，开始自动调用停止...");
                recstop();
              }, time);
            };

            rec.start();
            var set = rec.set;
            reclog((autoStop ? "[定时" + time + "ms]" : "") + "录制中：" + set.type + " " + set.sampleRate + "hz " + set.bitRate + "kbps");

            //【稳如老狗WDT】可选的，监控是否在正常录音有onProcess回调，如果长时间没有回调就代表录音不正常
            var wdt = rec.watchDogTimer = setInterval(function () {
              if (!rec || wdt != rec.watchDogTimer) { clearInterval(wdt); return } //sync
              if (Date.now() < rec.wdtPauseT) return; //如果暂停录音了就不检测：puase时赋值rec.wdtPauseT=Date.now()*2（永不监控），resume时赋值rec.wdtPauseT=Date.now()+1000（1秒后再监控）
              if (Date.now() - (processTime || startTime) > 1500) {
                clearInterval(wdt);
                reclog(processTime ? "录音被中断" : "录音未能正常开始", 1);
                // ... 错误处理，关闭录音，提醒用户
              }
            }, 1000);
            var startTime = Date.now(); rec.wdtPauseT = 0; processTime = 0;

            call();
          } else {
            call("未打开录音");
          };
        };
        var autoStopTimer;
        var cancelAutoStop = function () {
          if (autoStopTimer) {
            reclog("已取消定时停止", 1);
            clearTimeout(autoStopTimer);
            autoStopTimer = 0;
          };
        };
        function recpause() {
          if (rec) {
            rec.pause();
            rec.wdtPauseT = Date.now() * 2; //永不监控onProcess超时
            reclog("已暂停");
          };
        };
        function recresume() {
          if (rec) {
            rec.resume();
            rec.wdtPauseT = Date.now() + 1000; //1秒后再监控onProcess超时
            reclog("继续录音中...");
          };
        };
        var recblob = {};
        function recstop(call) {
          recstopFn(call, true, function (err, blob, time) {
            setTimeout(function () {
              if (!err && rec.set.takeoffEncodeChunk) {
                reclog("启用takeoffEncodeChunk后stop返回的blob长度为0不提供音频数据", "#f60");
                reclog("takeoffEncodeChunk接收到" + takeoffChunks.length + "片音频片段，正在合并成一个音频文件...");
                var len = 0;
                for (var i = 0; i < takeoffChunks.length; i++) {
                  len += takeoffChunks[i].length;
                };
                var chunkData = new Uint8Array(len);
                for (var i = 0, idx = 0; i < takeoffChunks.length; i++) {
                  var itm = takeoffChunks[i];
                  chunkData.set(itm, idx);
                  idx += itm.length;
                };
                var blob = new Blob([chunkData], { type: "audio/" + rec.set.type });
                addRecLog(time, "合并", blob, rec.set, Date.now());
              };
            });
          });
        };
        function recstopFn(call, isClick, endCall, rec) {
          cancelAutoStop();
          call || (call = function (msg) {
            msg && reclog(msg, 1);
          });
          rec = rec || window.rec;
          if (rec) {
            if (isClick) {
              reclog("正在编码" + rec.set.type + "...");
            };
            var t1 = Date.now();
            rec.watchDogTimer = 0; //停止监控onProcess超时
            rec.stop(function (blob, time) {
              var tag = endCall("", blob, time);
              if (tag == -1) {
                return;
              };

              addRecLog(time, tag || "已录制", blob, rec.set, t1);

              call(null, { data: blob, duration: time });
            }, function (s) {
              endCall(s);
              call("失败：" + s);
            });
          } else {
            call("未打开录音");
          };
        };
        var recLogLast;
        var addRecLog = function (time, tag, blob, set, t1) {
          var id = RandomKey(16);
          recLogLast = { blob: blob, set: $.extend({}, set), time: time, key: id };
          recblob[id] = recLogLast;
          var a1 = intp(Date.now() - t1, 4), a2 = intp(blob.size, 6);
          reclog(tag + ": " + intp(set.bitRate, 3) + "kbps " + intp(set.sampleRate, 5) + "hz "
            + "花" + a1 + "ms编码" + a2 + "B"
            + " [" + set.type + "]" + formatMs(time) + 'ms'
            + ' <button onclick="recdown(\'' + id + '\')">' + "下载" + '</button>'
            + ' <button onclick="recplay(\'' + id + '\')">' + "播放" + '</button>'
            + ' <span class="p' + id + '"></span> <span class="d' + id + '"></span>');
        };
        var intp = function (s, len) {
          s = s == null ? "-" : s + "";
          if (s.length >= len) return s;
          return ("_______" + s).substr(-len);
        };
        var formatMs = function (ms, all) {
          var ss = ms % 1000; ms = (ms - ss) / 1000;
          var s = ms % 60; ms = (ms - s) / 60;
          var m = ms % 60; ms = (ms - m) / 60;
          var h = ms;
          var t = (h ? h + ":" : "")
            + (all || h + m ? ("0" + m).substr(-2) + ":" : "")
            + (all || h + m + s ? ("0" + s).substr(-2) + "″" : "")
            + ("00" + ss).substr(-3);
          return t;
        };
        function recstop2() {
          if (!rec || !rec.buffers) {
            reclog("需先录个音", 1);
            return;
          };

          var type = $("[name=type]:checked").val();
          var sample = +$(".sample").val();
          var bits = /(\d+)\s+to\s+(\d+)\s+step\s+(\d+)\s*/i.exec($(".bits").val());
          if (!bits) {
            reclog("码率列表有误，需要? to ? step ?结构");
            return;
          };
          reclog("开始批量编码，请勿进行其他操作~");

          rec.set.type = type;
          rec.set.sampleRate = sample;

          var list = [];
          for (var i = +bits[1]; i < +bits[2] + 1; i += +bits[3]) {
            list.push(i);
          };
          if (/^(wav|pcm)$/.test(rec.set.type)) {
            list = [8, 16];
          };
          if (rec.set.type == "amr") {
            list = [4.75, 5.15, 5.9, 6.7, 7.4, 7.95, 10.2, 12.2];
          };


          var i = -1;
          var bak = rec.set.bitRate;
          var run = function () {
            i++;
            if (i >= list.length) {
              rec.set.bitRate = bak;
              reclog("批量编码完成");
              return;
            };
            rec.set.bitRate = list[i];
            rec.isMock = 1;
            recstopFn(null, 0, function () {
              setTimeout(run);
            });
          };
          run();
        };
        function recplay(key) {
          var audio = $(".recPlay")[0];
          audio.style.display = "inline-block";
          if (!(audio.ended || audio.paused)) {
            audio.pause();
          };

          var o = recblob[key];
          if (o) {
            o.play = (o.play || 0) + 1;
            var logmsg = function (msg) {
              $(".p" + key).html('<span style="color:green">' + o.play + '</span> ' + new Date().toLocaleTimeString() + " " + msg);
            };
            logmsg("");
            audio.onerror = function (e) {
              logmsg('<span style="color:red">' + "播放失败" + '[' + audio.error.code + ']' + audio.error.message + '</span>');
            };

            var end = function (blob) {
              audio.src = (window.URL || webkitURL).createObjectURL(blob);
              audio.play();
            };
            var wav = Recorder[o.set.type + "2wav"];
            if (wav) {
              logmsg("正在转码成wav...");
              var wavData = o.blob;
              if (o.set.type == "pcm") {
                wavData = {
                  sampleRate: o.set.sampleRate
                  , bitRate: o.set.bitRate
                  , blob: o.blob
                };
              };
              wav(wavData, function (blob) {
                end(blob);
                logmsg("已转码成wav播放");
              }, function (msg) {
                logmsg('<span style="color:red">' + "转码成wav失败：" + msg + '</span>');
              });
            } else {
              end(o.blob);
            };
          };
        };
        function recPlayLast() {
          if (!recLogLast) {
            reclog("请先录音，然后停止后再播放", 1);
            return;
          };
          recplay(recLogLast.key);
        };

        function recDownLast() {
          if (!recLogLast) {
            reclog("请先录音，然后停止后再下载", 1);
            return;
          };
          recdown(recLogLast.key);
        };
        function recdown(key) {
          var o = recblob[key];
          if (o) {
            var cls = RandomKey(16);
            var name = "rec-" + o.time + "ms-" + o.set.bitRate + "kbps-" + o.set.sampleRate + "hz." + o.set.type;

            o.down = (o.down || 0) + 1;
            $(".d" + key).html('<span style="color:red">' + o.down + '</span> '
              + "点击" + ' <span class="' + cls + '"> '
              + "下载，或复制文本"
              + '<button onclick="recdown64(\'' + key + '\',\'' + cls + '\')">' + "生成Base64文本" + '</button></span>');

            var downA = document.createElement("A");
            downA.innerHTML = "下载 " + name;
            downA.href = (window.URL || webkitURL).createObjectURL(o.blob);
            downA.download = name;
            $("." + cls).prepend(downA);
            if (/mobile/i.test(navigator.userAgent)) {
              alert("因移动端绝大部分国产浏览器未适配Blob Url的下载，所以本demo代码在移动端未调用downA.click()。请尝试点击日志中显示的下载链接下载，无法下载就复制Base64");
            } else {
              downA.click();
            }
          };
        };
        function recdown64(key, cls) {
          var o = recblob[key];

          var reader = new FileReader();
          reader.onloadend = function () {
            var id = RandomKey(16);
            $("." + cls).append('<textarea class="' + id + '"></textarea>');
            $("." + id).val(reader.result);
          };
          reader.readAsDataURL(o.blob);
        };
        var ReadBlob = function (blob, call) {
          var reader = new FileReader();
          reader.onloadend = function (e) {
            call(reader.result);
          };
          reader.readAsArrayBuffer(blob);
        };
        var DecodeAudio = function (fileName, arrayBuffer, True, False) {
          True = True || function () { };
          False = False || function () { };
          if (!Recorder.GetContext()) {//强制激活Recorder.Ctx 不支持大概率也不支持解码
            False("浏览器不支持音频解码");
            return;
          };
          var type = (/[^.]+$/.exec(fileName) || [])[0] || "";
          var srcBlob = new Blob([arrayBuffer], { type: type && ("audio/" + type) || "" });

          var ctx = Recorder.Ctx;
          ctx.decodeAudioData(arrayBuffer, function (raw) {
            var src = raw.getChannelData(0);
            var sampleRate = raw.sampleRate;
            console.log(fileName, raw, srcBlob);

            var pcm = new Int16Array(src.length);
            for (var i = 0; i < src.length; i++) {//floatTo16BitPCM 
              var s = Math.max(-1, Math.min(1, src[i]));
              s = s < 0 ? s * 0x8000 : s * 0x7FFF;
              pcm[i] = s;
            };

            True({
              sampleRate: sampleRate
              , duration: Math.round(src.length / sampleRate * 1000)
              , srcBlob: srcBlob
              , type: type
              , data: pcm
            });
          }, function (e) {
            console.error("DecodeAudio error", e);
            False(fileName + "解码失败:" + (e && e.message || "-"));
          });
        };



        var s = "https://github.com/xiangyuecn/Recorder/blob/master/src/extensions/";
        var getExtensionsInfo = function () {
          return {
            WaveView: '<b>WaveView</b> (<a href="' + s + 'waveview.js">waveview.js</a> ' + "动态波形" + ')'
            , SurferView: '<b>WaveSurferView</b> (<a href="' + s + 'wavesurfer.view.js">wavesurfer.view.js</a> ' + "音频可视化波形" + ')'
            , Histogram: '<b>FrequencyHistogramView</b> (<a href="' + s + 'frequency.histogram.view.js">frequency.histogram.view.js</a> + <a href="' + s + 'lib.fft.js">lib.fft.js</a> ' + "音频可视化频率直方图" + ')'
          }
        };
        var recwaveChoiceKey = localStorage["RecWaveChoiceKey"] || "WaveView";
        $(".recwaveChoice").bind("click", function (e) {
          var elem = $(e.target);
          $(".recwaveChoice").removeClass("slc");
          var val = elem.addClass("slc").attr("key");
          var info = getExtensionsInfo()[val.replace(/\d+$/, "")];
          if (recwaveChoiceKey != val) {
            reclog("已切换波形显示为：" + info);
          };
          recwaveChoiceKey = val;
          localStorage["RecWaveChoiceKey"] = recwaveChoiceKey;
        });
        if (!$(".recwaveChoice[key=" + recwaveChoiceKey + "]").length) {
          recwaveChoiceKey = "WaveView";
        };
        $(".recwaveChoice[key=" + recwaveChoiceKey + "]").click();

        var initWaveStore = function (store, elem) {
          store.WaveView = Recorder.WaveView({ elem: elem });
          store.SurferView = Recorder.WaveSurferView({ elem: elem });
          store.Histogram1 = Recorder.FrequencyHistogramView({ elem: elem });
          store.Histogram2 = Recorder.FrequencyHistogramView({
            elem: elem
            , lineCount: 200, widthRatio: 1
            , position: 0
            , minHeight: 1
            , fallDuration: 600
            , stripeEnable: false
            , mirrorEnable: true
          });
          store.Histogram3 = Recorder.FrequencyHistogramView({
            elem: elem
            , lineCount: 20
            , position: 0
            , minHeight: 1
            , fallDuration: 400
            , stripeEnable: false
            , mirrorEnable: true
            , linear: [0, "#0ac", 1, "#0ac"]
          });
        };


        if (window.isSecureContext === false) {
          reclog("当前网页不是安全环境（HTTPS），将无法获取录音权限，" + "<a href='https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/getUserMedia#Privacy_and_security'>MDN Privacy and security</a>", 1);
        } else if (window.isSecureContext) {
          reclog("<span style='color:#0b1'>" + "当前网页处在安全环境中" + "</span>(<a href='https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/getUserMedia#Privacy_and_security'>" + "https、file:///等" + "</a>)");
        };

        reclog("点击打开录音开始哦，此浏览器"
          + "<span style='color:" + (Recorder.Support() ? "green" : "red") + "'>"
          + (Recorder.Support() ? "支持录音" : "不支持录音") + "</span>");
        var dh = "、", extensionsInfo = getExtensionsInfo();
        reclog("已启用Extensions："
          + extensionsInfo.WaveView
          + dh + extensionsInfo.SurferView
          + dh + extensionsInfo.Histogram);



        var workletTips = "注意：由于AudioWorklet内部"
          + '<a href="https://developer.mozilla.org/en-US/docs/Web/API/AudioWorkletProcessor/process" target="_blank">' + "1秒会产生375次回调" + '</a>'
          + "，在移动端可能会有性能问题导致浏览器回调丢失，进而导致录音数据、时长变短，PC端似乎无此影响，可通过定时1分钟录音来检测影响（如果短了1秒以上即为有问题）；在无明显优势好处的前提下，暂不建议启用。";
        $(".workletSetTips").html(workletTips);
        $(".enableWorkletSet").bind("change", function () {
          localStorage["RecEnableWorklet"] = this.checked ? "1" : "";
        })[0].checked = localStorage["RecEnableWorklet"] == "1";

        $(".enableWebMSet").bind("change", function () {
          localStorage["RecEnableWebM"] = this.checked ? "1" : "-1";
        })[0].checked = localStorage["RecEnableWebM"] != "-1";

        //页面滚动到这个位置
        var scrollToEl = function (elem) {
          $("html,body").animate({ scrollTop: $(elem).offset().top - 200 }, 300);
        };



        $(".recinfoCode").html($(".recinfoCodeTxt").val().replace(/\$\{(.+?)\}|\{\{([\S\s]+?)\}\}/g, function (a, b, c) { return eval(b || c) }));

        //暴力测试：同时打开5个录音，定时录5秒
        var testMultipleOpen5 = function () {
          if (rec) rec.close();
          for (var i = 0; i < 5; i++) {
            (function (i) {
              var rec = Recorder({
                type: "mp3"
                , onProcess: function (buffers, powerLevel, duration, sampleRate, newBufferIdx, asyncEnd) {
                  Recorder.CLog(i + 1, 0, duration, buffers.length, newBufferIdx);
                }
              });
              rec.open(function () {
                rec.start();
                setTimeout(function () {
                  var t1 = Date.now();
                  rec.stop(function (blob, duration) {
                    addRecLog(duration, "第" + (i + 1) + "个", blob, rec.set, t1);
                  }, null, true);
                }, 5000);
              });
            })(i)
          }
        };


        //注入小时的录音数据
        var testInject24HourPcmStore = { sid: 0 };
        var testInject24HourPcmClick = function () {
          var H = +$(".testInject24HourPcm_h").val();
          if (!H) { reclog("hour?", 1); return; }
          if (!rec || !rec.state) { reclog("需开始录音", 1); return; }
          if (!rec.set.takeoffEncodeChunk) { reclog("需勾选takeoffEncodeChunk", 1); return; }

          var store = testInject24HourPcmStore;
          var sid = ++store.sid;
          var startTime = Date.now(), lastTime = 0, minute = 0, pcmSize = 0, takeSize = 0, takeIdx = 0;

          var cls = RandomKey(16);
          reclog('<span class="' + cls + '">Run...</span>');
          var update = function () {
            var tag = '<span style="color:' + (minute > H * 60 ? '#0b1">OK' : '#f60">Run...') + '</span> ';
            var t = formatMs(Date.now() - startTime, 1);
            $("." + cls).html(tag + "已注入" + ~~(minute / 60) + "小时" + (minute % 60) + "分钟数据，输入pcm: " + (pcmSize / 1024 / 1024).toFixed(2) + " MB，输出音频: " + (takeSize / 1024 / 1024).toFixed(2) + " MB（已清除不占用内存）。设置共注入" + H + "小时数据，注入耗时：" + t);
          };
          update();

          window.testInject24HourPcmOnProc = function (buffers, sampleRate) {
            if (sid != store.sid) return;
            for (var i = buffers.length - 2; i >= 0; i--) {
              if (!buffers[i]) break;
              buffers[i] = null;//清除缓冲数据
            }
          };
          window.testInject24HourPcmOnTake = function (bytes) {
            if (sid != store.sid) return;
            takeSize += bytes.byteLength;
            if (lastTime && bytes.byteLength < 50000) return; //1分钟数据>50kb，排除掉实时录音数据
            lastTime = Date.now();
            //清除注入的音频结果
            for (; takeIdx < takeoffChunks.length; takeIdx++) {
              if (takeoffChunks[takeIdx].byteLength > 50000) {
                takeoffChunks[takeIdx] = new Uint8Array(0);
              }
            }
            //已达到时间
            if (minute > H * 60) { update(); return; }
            //延迟一下，注入1分钟数据进行编码
            setTimeout(function () {
              var pcm = new Int16Array(rec.srcSampleRate * 60);
              pcmSize += pcm.byteLength;
              minute++;
              rec.envIn(pcm, 0);
              update();
            }, 10);
          };
        };


        //阻止手机自动锁屏
        var wakeLockClick = function () {
          var fail = function () {
            reclog("浏览器不支持wakeLock接口，无法阻止自动锁屏", 1);
          };
          if (navigator.wakeLock) {
            if (window.wakeLockObj) wakeLockObj.release();
            navigator.wakeLock.request('screen').then(function (lock) {
              wakeLockObj = lock;
              reclog("已通过wakeLock阻止自动锁屏" + ' <button onclick="wakeUnLockClick(this)">' + "恢复锁屏" + '</button>');
              window.wakeUnLockClick = function (btn) {
                lock.release().then(function () {
                  wakeLockObj = null; $(btn).remove();
                  reclog("已恢复自动锁屏");
                });
              };
              scrollToEl(".reclog");
            })['catch'](function (e) {
              console.error("wakeLock错误：" + e.message);
              fail();
            });
          } else {
            fail();
          }
        };

      </script>

    </div><!-- demoMain end -->

    <div style="padding:100px;"></div>
    <!-- end 结束copy源码 -->

    <script>
      (function () {
        var i = 0, arr = [], html = [];
        for (var k in TypeEngineImports) {
          i++;
          var o = TypeEngineImports[k]; o.sort = o.sort || i; o.type = k; arr.push(o);
        }
        arr.sort(function (a, b) { return a.sort - b.sort });
        for (var i = 0; i < arr.length; i++) {
          var o = arr[i];
          html.push('<label><input type="radio" name="type" value="' + o.type + '">' + (o.name || o.type) + '</label>');
        }

        var prev;
        $(".types").html(html.join(" ")).bind("click", function (e) {
          var input = $(e.target);
          if (input[0].nodeName == "LABEL") {
            input = $(input).find("input");
          };
          input = input[0]; if (!input || input.nodeName != "INPUT") return;
          if (prev != input) {
            prev = input;
            setTimeout(function () {
              loadEngine(input.value, 1);
            });
          };
        });
      })();
      function loadEngine(type, isClick) {
        var eImport = TypeEngineImports[type];
        if (!eImport) return;

        var srcs = [], mins = [], adds = [];
        for (var i = 1, a = 0; i < eImport.src.length; i++) {
          var v = eImport.src[i];
          if (v === 0) { a = 1; continue; }
          if (a) adds.push(v);
          else srcs.push(v);
        };

        var engines = [].concat(srcs, adds || []);
        var end = function () {
          var enc = Recorder.prototype["enc_" + type];
          var tips = [];
          if (!enc) {
            tips.push("这个编码器无提示信息");
          } else {
            if (enc.stable) {
              tips.push(type + "编码器稳定版，");
            } else {
              tips.push(type + "编码器beta版，");
            };
            tips.push("<span style='color:");
            var fastMsg = enc.fast ? type + "转码超快" : "";
            if (Recorder.prototype[type + "_start"]) {
              tips.push("#0b1'>" + (fastMsg ? fastMsg + " + " : "") + "支持边录边转码(Worker)");
            } else if (fastMsg) {
              tips.push("#0b1'>" + fastMsg);
            } else {
              tips.push("red'>" + "仅支持标准UI线程转码");
            };
            tips.push("</span>, " + (enc.getTestMsg && enc.getTestMsg() || enc.testmsg));
          }

          $(".typeTips").html(tips.join(""));

          resetPageTitle();
          if (isClick) {
            keepTypeInHash(type);
          }
          reclog("<span style='color:#0b1'>" + typeTips() + "已加载，可以录音了" + "</span>");
        };
        $(".typeTips").html(type + " engine loading...");
        var typeTips = function () {
          return type + "编码器源码版";
        };
        if (!Recorder.prototype[type]) {
          reclog("<span style='color:#f60'>" + "正在加载" + typeTips() + "，请勿操作..." + "</span>");
          loadJsList(engines, function () {
            end();
          }, function (err) {
            $(".typeTips").html('<span style="color:red">' + type + " engine loading error: " + err + '</span>');
            reclog(err, 1);
          });
        } else {
          end();
        };
      };
      loadEngineState = {};

      var keepTypeInHash = function (type) {
        var o = { type: type };
        var hash = (location.hash || "#").replace(/(#?)&?recImport=([^&]*)/g, "$1");
        if (type != "mp3") {
          hash += (hash == "#" ? "" : "&") + "recImport=";
          hash += encodeURIComponent(JSON.stringify(o));
        }
        if (history.replaceState) {
          history.replaceState(null, "", hash);
        } else {
          location.hash = hash;
        }
      };
      var resetPageTitle = function () {
        var type = $("[name=type]:checked").val();
        var title = document.title.replace(/^\[\w+\]/g, "");
        if (type != "mp3") title = "[" + type.toUpperCase() + "]" + title;
        document.title = title;
      };

      var loadJsList = function (jsList, True, False, allCheck) {//False -> false继续加载，allCheck(urlItem)允许修改url值
        var rootUrl = "";
        var load = function (idx) {
          if (idx >= jsList.length) {
            True && True();
            return;
          };
          var itm = jsList[idx];
          if (typeof (itm) == "string") itm = { url: itm };
          if (itm.check && itm.check() === false) {
            load(idx + 1);
            return;
          };
          if (allCheck && allCheck(itm) === false) {
            load(idx + 1);
            return;
          };
          var url = itm.url;

          var elem = document.createElement("script");
          elem.setAttribute("type", "text/javascript");
          elem.setAttribute("src", (/^\w+:/.test(url) ? "" : rootUrl) + url);
          if (!("onload" in elem)) {//IsLoser 古董浏览器
            elem.onreadystatechange = function () {
              if (elem.readyState == "loaded") {
                elem.onload();
              }
            }
          };
          var isload = 0;
          elem.onload = function () {
            if (!isload) {
              load(idx + 1);
              isload = 1;
            }
          };
          elem.onerror = function (e) {
            var v = False && False("js加载失败:" + (e.message || "-") + ", " + url, 1);
            if (v === false) {
              elem.onload();
            }
          };
          $("head")[0].appendChild(elem);
        };
        setTimeout(function () { load(0) });
      };

      (function () {
        try {
          //加载默认类型编码器
          var type = Import_RecJs_Set.type || "mp3";
          var els = $("input[name=type]"), el = 0;
          for (var i = 0; i < els.length; i++) {
            if (els[i].value == type) el = els[i];
          }
          el.checked = true;
          loadEngine(el.value);

          //pcm测试页面来的
          if (/ispcm=1/.test(location.href)) {
            $(".demoHead,.gitUrl,.btns,.recpower,.waveBox,.pcmPageHide").hide();
          };
        } catch (e) { console.error(e) }
      })();
    </script>
  </div>
</body>

</html>